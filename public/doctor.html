<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e8f5e8, #f0f9f0);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px;
      background: linear-gradient(135deg, #2e7d32, #4caf50);
      color: white;
    }

    .doctor-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .doctor-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
    }

    .doctor-avatar.placeholder {
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
    }

    .doctor-details h1 {
      margin: 0;
      font-size: 1.8em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .doctor-details p {
      margin: 5px 0;
      opacity: 0.9;
    }

    .logout-btn {
      background: #d32f2f;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #b71c1c;
    }

    .content {
      padding: 30px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f0f9f0, #e8f5e8);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #e8f5e8;
      transition: transform 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      color: #2e7d32;
      margin: 0 0 10px 0;
      font-size: 2.2em;
      font-weight: bold;
    }

    .stat-card p {
      color: #666;
      margin: 0;
      font-weight: 500;
    }

    .section-title {
      color: #2e7d32;
      margin-bottom: 20px;
      font-size: 1.5em;
      font-weight: 600;
      border-bottom: 2px solid #e8f5e8;
      padding-bottom: 10px;
    }

    .assessment {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      border-left: 6px solid #4caf50;
    }

    .assessment:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .assessment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .assessment-meta {
      color: #666;
      font-size: 0.9em;
    }

    .risk-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.8em;
      text-transform: uppercase;
    }

    .risk-high {
      background: #ffebee;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }

    .risk-medium {
      background: #fff3e0;
      color: #f57c00;
      border: 1px solid #ffcc02;
    }

    .risk-low {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .assessment h4 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.2em;
    }

    .prediction {
      margin: 15px 0;
      padding: 12px;
      background: #fff3e0;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }

    .prediction strong {
      color: #f57c00;
    }

    .confidence {
      margin: 10px 0;
      color: #666;
      font-size: 0.9em;
    }

    .symptoms {
      margin-top: 15px;
    }

    .symptoms-label {
      font-weight: 600;
      color: #2e7d32;
      margin-bottom: 10px;
      display: block;
    }

    .symptoms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .symptom-item {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      text-align: center;
      font-weight: 500;
      transition: transform 0.2s ease;
    }

    .symptom-item:hover {
      transform: scale(1.05);
    }

    .symptom-yes {
      background: #ffebee;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }

    .symptom-no {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4caf50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-assessments {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 60px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #dee2e6;
    }

    .no-assessments h3 {
      color: #495057;
      margin-bottom: 10px;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #f5c6cb;
      text-align: center;
    }

    .additional-message {
      margin-top: 15px;
      padding: 12px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #2196f3;
    }

    .additional-message strong {
      color: #1976d2;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .doctor-info {
        flex-direction: column;
        text-align: center;
      }

      .stats {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .assessment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="doctor-info">
        <div id="doctorAvatar" class="doctor-avatar placeholder">üë®‚Äç‚öïÔ∏è</div>
        <div class="doctor-details">
          <h1 id="doctorName">Loading...</h1>
          <p id="doctorSpecialty">Loading...</p>
          <p id="doctorLocation">Loading...</p>
        </div>
      </div>
      <form action="/logout" method="POST" style="display: inline;">
        <button type="submit" class="logout-btn">Logout</button>
      </form>
    </div>

    <div class="content">
      <div class="stats" id="statsContainer">
        <div class="stat-card">
          <h3 id="totalAssessments">-</h3>
          <p>Total Assessments</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingReviews">-</h3>
          <p>Pending Reviews</p>
        </div>
        <div class="stat-card">
          <h3 id="highRiskCases">-</h3>
          <p>High Risk Cases</p>
        </div>
        <div class="stat-card">
          <h3 id="todayAssessments">-</h3>
          <p>Today's Assessments</p>
        </div>
      </div>

      <h2 class="section-title">Patient Assessments</h2>
      <div id="assessmentContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading assessments...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentDoctor = null;
    let doctorAssessments = [];

    // Load current doctor info and assessments
    async function loadDoctorInfo() {
      try {
        // Get current doctor info from session/API
        const response = await fetch('/api/current-doctor');
        if (!response.ok) {
          throw new Error('Failed to load doctor info');
        }
        
        const doctor = await response.json();
        currentDoctor = doctor;
        
        // Update UI with doctor info
        updateDoctorDisplay(doctor);
        
        // Load assessments for this doctor
        await loadAssessments(doctor.id);
        
      } catch (error) {
        console.error('Error loading doctor info:', error);
        document.getElementById('doctorName').textContent = 'Error Loading Doctor';
        document.getElementById('assessmentContainer').innerHTML = 
          '<div class="error-message">Failed to load doctor information. Please refresh the page.</div>';
      }
    }

    function updateDoctorDisplay(doctor) {
      document.getElementById('doctorName').textContent = doctor.name;
      document.getElementById('doctorSpecialty').innerHTML = `<strong>Specialty:</strong> ${doctor.specialty}`;
      document.getElementById('doctorLocation').innerHTML = `<strong>Location:</strong> ${doctor.location}`;
      
      // Update avatar
      const avatarElement = document.getElementById('doctorAvatar');
      if (doctor.photo) {
        avatarElement.innerHTML = `<img src="${doctor.photo}" alt="${doctor.name}" class="doctor-avatar">`;
      } else {
        avatarElement.innerHTML = 'üë®‚Äç‚öïÔ∏è';
        avatarElement.className = 'doctor-avatar placeholder';
      }
      
      // Update page title
      document.title = `Doctor Dashboard - ${doctor.name}`;
    }

    async function loadAssessments(doctorId) {
      const container = document.getElementById("assessmentContainer");

      try {
        const response = await fetch(`/api/getDoctorAssessments?doctorId=${doctorId}`);
        if (!response.ok) {
          throw new Error('Failed to load assessments');
        }
        
        const data = await response.json();
        doctorAssessments = data;
        
        updateStats(data);
        displayAssessments(data, container);
        
      } catch (error) {
        console.error('Error loading assessments:', error);
        container.innerHTML = '<div class="error-message">Failed to load assessments. Please try again.</div>';
      }
    }

    function updateStats(assessments) {
      const total = assessments.length;
      const pending = assessments.filter(a => a.status === 'pending').length;
      const highRisk = assessments.filter(a => a.riskLevel === 'High').length;
      
      // Calculate today's assessments
      const today = new Date().toDateString();
      const todayCount = assessments.filter(a => 
        new Date(a.timestamp).toDateString() === today
      ).length;

      document.getElementById('totalAssessments').textContent = total;
      document.getElementById('pendingReviews').textContent = pending;
      document.getElementById('highRiskCases').textContent = highRisk;
      document.getElementById('todayAssessments').textContent = todayCount;
    }

    function displayAssessments(data, container) {
      if (!data.length) {
        container.innerHTML = `
          <div class="no-assessments">
            <h3>No assessments yet</h3>
            <p>You haven't received any patient assessments. Assessments from patients will appear here.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = "";
      
      // Sort assessments by timestamp (newest first)
      const sortedAssessments = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      sortedAssessments.forEach((assessment, index) => {
        const card = document.createElement("div");
        card.className = "assessment";
        
        const date = new Date(assessment.timestamp).toLocaleString();
        const riskClass = assessment.riskLevel ? 
          `risk-${assessment.riskLevel.toLowerCase()}` : 'risk-medium';
        
        let symptomsHtml = '';
        if (assessment.symptoms && Object.keys(assessment.symptoms).length > 0) {
          const symptomItems = Object.entries(assessment.symptoms).map(([symptom, value]) => 
            `<div class="symptom-item symptom-${value}">${symptom}: ${value}</div>`
          ).join('');
          
          symptomsHtml = `
            <div class="symptoms">
              <span class="symptoms-label">Reported Symptoms:</span>
              <div class="symptoms-grid">${symptomItems}</div>
            </div>
          `;
        }
        
        let additionalMessageHtml = '';
        if (assessment.additionalMessage || assessment.patientMessage) {
          const message = assessment.additionalMessage || assessment.patientMessage;
          additionalMessageHtml = `
            <div class="additional-message">
              <strong>Patient Message:</strong><br>
              ${message}
            </div>
          `;
        }
        
        card.innerHTML = `
          <div class="assessment-header">
            <div class="assessment-meta">
              <strong>From:</strong> ${assessment.from} | 
              <strong>Received:</strong> ${date}
            </div>
            <div class="risk-badge ${riskClass}">
              ${assessment.riskLevel || 'Medium'} Risk
            </div>
          </div>
          
          <h4>Assessment #${sortedAssessments.length - index}</h4>
          
          ${assessment.prediction ? `
            <div class="prediction">
              <strong>AI Prediction:</strong> ${assessment.prediction}
            </div>
          ` : ''}
          
          ${assessment.confidence ? `
            <div class="confidence">
              <strong>Confidence:</strong> ${Math.round((assessment.confidence || 0) * 100)}%
            </div>
          ` : ''}
          
          ${symptomsHtml}
          ${additionalMessageHtml}
        `;
        
        container.appendChild(card);
      });
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadDoctorInfo();
    });

    // Auto-refresh assessments every 30 seconds
    setInterval(() => {
      if (currentDoctor) {
        loadAssessments(currentDoctor.id);
      }
    }, 30000);
  </script>
</body>
</html>